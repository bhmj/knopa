<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name=viewport content="width=device-width, initial-scale=1">
<title>Knopa.online</title>
<link rel="stylesheet" type="text/css" href="/knopa.m.css"/>
<script type="text/javascript" src="/knopa.m.js"></script>
<script type="text/javascript">/*<![CDATA[*/function init(){var d=[{n:"Info"},{n:"System"},{n:"Time"},{n:"WiFi"},{n:"Cloud"},{n:"Pins"}];var a=[[{n:"Device info",t:"txt",fld:"devinfo"},{n:"Firmware version",t:"txt",fld:"fver"},{n:"SDK + boot version",t:"txt",fld:"sdkboot"},{n:"Free heap",t:"txt",fld:"heap"},{n:"Check new version",t:"btn",b:"Check",click:"check_upd(this)"},{n:"Uptime",t:"txt",fld:"uptime"},{n:"Restart the device",t:"btn",b:"Restart",click:"reboot()"}],[{n:"AP SSID",t:"edit",fld:"apssid"},{n:"AP password",t:"pwd",fld:"appass"},{n:"Device name",t:"edit",fld:"name"},{n:"Measure period",t:"edit",fld:"measure",w:"5em",suf:"sec"},{n:"Sleep",t:"chk",fld:"pwsave"},{n:"Auto update",t:"chk",fld:"autoupd"},{n:"Debug output",t:"cb",fld:"dbglvl",v:"none|procs|key data|most|total"},{n:"&nbsp;",t:"btn",b:"Save",click:"save_sys()"},],[{n:"Knopa time",t:"txt",fld:"ctime"},{n:"SNTP server 1",t:"edit",fld:"ntps1"},{n:"SNTP server 2",t:"edit",fld:"ntps2"},{n:"SNTP server 3",t:"edit",fld:"ntps3"},{n:"Timezone",t:"edit",fld:"tz",w:"7em"},{n:"&nbsp;",t:"btn",b:"Save",click:"save_ntp()"}],[{n:"SSID",t:"edit",fld:"wifissid"},{n:"Password",t:"pwd",fld:"wifipass"},{n:"BSSID (opt)",t:"edit",fld:"wifibssid"},{n:"&nbsp;",t:"btn",b:"Save",click:"save_wifi()"},{n:"Status",t:"txt",fld:"apstatus"},{n:"&nbsp;",t:"btn",b:"Connect|Disconnect",click:"wifi_connect(!)"},{n:"&nbsp;",t:"txt"},{n:"Scan for APs",t:"btn",b:"Scan",click:"wifi_scan()"},{t:"2list",fld:"aps"},],[{n:"Server 1",t:"edit",fld:"clserv1"},{n:"User",t:"edit",fld:"cluser1"},{n:"Password",t:"pwd",fld:"clpass1"},{n:"Server 2",t:"edit",fld:"clserv2"},{n:"User",t:"edit",fld:"cluser2"},{n:"Password",t:"pwd",fld:"clpass2"},{n:"Connection",t:"cb",fld:"clconn",v:"Off|Periodic|Constant"},{n:"Period",t:"edit",fld:"clsync",w:"5em",suf:"measures"},{n:"&nbsp;",t:"btn",b:"Save",click:"save_cloud()"}],[{n:"&nbsp;",t:"2btn",b:"Add...",click:"pin_add()"},{t:"2list",fld:"pins"},{n:"&nbsp;",t:"2btn",b:"Save",click:"save_pins()"}]];$("tabs").innerHTML=nsTmpl.tmplr("tab",d);d=$$(".tab");for(var c=0;c<d.length;c++){var f=document.createElement("div");f.className="sheet "+(c?"":"sel");var b='<table class="tbl">'+nsTmpl.tmplr("tblrow",a[c])+"</table>";f.innerHTML=b;$("space").appendChild(f)}tab_switch(d[0]);cEnv.ctime=Date.now()/1000|0;tick();setInterval(tick.bind(this),1000);cEnv.gpio=[];for(var c=0;c<16;c++){cEnv.gpio[c]={id:c+1,name:c+1}}ajaxGet("/","read=1",data_ready);ajaxGet("/","sync="+(Date.now()/1000|0));setInterval(status.bind(this),3000)}function status(){ajaxGetq("/","status=1",data_ready,1)}function tick(){++cEnv.ctime;var e=new Date(cEnv.ctime*1000);e.setSeconds(e.getSeconds()+1);function f(d){return d<10?"0"+d:d}var g=f(e.getDate()),a=f(e.getMonth()+1),j=e.getFullYear();var c=f(e.getHours()),i=f(e.getMinutes()),b=f(e.getSeconds());$("id-ctime").innerHTML=j+"-"+a+"-"+g+" "+c+":"+i+":"+b;j=cEnv.uptime++;g=j/86400|0;j%=86400;c=j/3600|0;j%=3600;i=j/60|0;b=j%60|0;$("id-uptime").innerHTML=(g?g+"d ":"")+f(c)+":"+f(i)+":"+f(b)}function data_ready(f,c){var g=pjson(f);if(!g){return}for(var b in g){if(g.hasOwnProperty(b)){var a=g[b];if(b=="tz"){var j=Math.abs(a%60);a="GMT"+(a>=0?"+":"")+(a/60|0)+(j?":"+j+(j<10?"0":""):"")}var h=$("id-"+b);if(h){if(h.tagName=="INPUT"){if(h.type=="checkbox"){h.checked=a}else{h.value=a}}if(h.tagName=="SPAN"){h.innerHTML=a}if(h.tagName=="SELECT"){h.selectedIndex=a}}cEnv[b]=a;if(b=="pins"){for(var d=0;d<a.length;d++){pin_add(a[d])}}}}if(!c){msg("",1)}}function tab_switch(d){var c=$$(".tab");var b=$$(".sheet");for(var a=0;a<c.length;a++){c[a].className=c[a]==d?"tab sel":"tab";b[a].className=c[a]==d?"sheet sel":"sheet"}}function peep(b){var a=b.previousSibling.previousSibling;a.type=(a.type=="text"?"password":"text")}function check_upd(a){ajaxGet("/","chupd=1",upd_ready,a)}function do_upd(a){ajaxGetq("/","doupd=1",upd_ready,a);msg("Downloading and installing...",1)}function upd_ready(b,a){var c=pjson(b);if(!c){return}if(c.new_ver){msg("New firmware version available: "+c.new_ver+" ("+c.size+" Kb)",1);a.value="Update!";a.onclick=do_upd.bind(this,a)}else{msg("You have the latest firmware")}}function save_sys(){ajaxGet("/","sys=1"+$vV("apssid")+$vV("appass")+$vV("name")+$vV("measure")+$cV("pwsave")+$cV("autoupd")+$vV("dbglvl"),save_cb)}function save_wifi(){ajaxGet("/","wifi=1"+$vV("wifissid")+$vV("wifipass")+$vV("wifibssid"),save_cb)}function save_cloud(){ajaxGet("/","cloud=1"+$vV("clserv1")+$vV("cluser1")+$vV("clpass1")+$vV("clserv2")+$vV("cluser2")+$vV("clpass2")+$vV("clconn")+$vV("clsync"),save_cb)}function save_ntp(){ajaxGet("/","ntp=1"+$vV("ntps1")+$vV("ntps2")+$vV("ntps3")+$vV("tz"),save_cb)}function save_pins(b){var c=$$("select",$("id-pins"));cEnv.pinid=[];cEnv.pintype=[];for(var d=0;d<c.length;d++){if(c[d].className=="pintype"){cEnv.pintype.push(c[d].value)}else{cEnv.pinid.push(c[d].value)}}ajaxGet("/","pins="+cEnv.pinid.join("+")+"&types="+cEnv.pintype.join("+"),b?b:save_cb)}function reboot(){ajaxGet("/","reboot=1");msg("Device rebooted")}function wifi_scan(){ajaxGet("/","scan=1",wifi_scan_cb)}function wifi_scan_cb(b){var c=pjson(b);if(!c){return}var a={ssid:"SSID",ch:"Channel",rssi:"Signal, dB",sec:"Security"};c.sort(function(e,d){e.rssi|=0;d.rssi|=0;return(e.rssi<d.rssi)?1:((e.rssi>d.rssi)?-1:0)});$("id-aps").innerHTML=nsTmpl.tmpl("apitem",a)+nsTmpl.tmplr("apitem",c);msg()}function wifi_connect(a){msg("Switching WiFi...");ajaxGetq("/","conn=1&on="+(1-a))}function save_cb(a){var b=pjson(a);if(!b){return}if(b.result="ok"){msg("Saved")}else{err("Error")}}function pin_add(h){var b=$$(".pinnum");var d=b.length?(b[b.length-1].value|0):0;var f=0;if(h){d=h.id;for(var c=0;c<cEnv.hwtype.length;c++){if(cEnv.hwtype[c].id==h.type){f=c}}}var g=document.createElement("tr");g.innerHTML=nsTmpl.tmpl("pinitem",{});$$(".pinnum",g)[0].selectedIndex=d%16;$$(".pintype",g)[0].selectedIndex=f%16;$("id-pins").appendChild(g)}function pin_del(a){$X($top(a,"tr"))}function pin_cfg(b){function c(d){location.href="/kconfig.2.html?pin="+d}var a=$$(".pinnum",$top(b,"tr"))[0].value;save_pins(c.bind(this,a))};/*]]>*/</script>
</head>
<body onload="init()"><div class="page"><h1>Knopa.online</h1><ul id="tabs"></ul><div id="space"></div><div id="footer"><div id="err"></div><div id="msg"></div></div></div></body>
<script class="tab" type="text/html"><li class="tab" onclick="tab_switch(this)"><%=n%></li></script>
<script class="tblrow" type="text/html"><tr class="row"><% if (t[0]!='2') { %><td class="cell"><%=n%></td><% } %><td class="cell" <%=(t[0]=='2'?'colspan=2':'')%>><%=nsTmpl.tmpl('fld_'+t.replace(/\d/,'' ),{obj:obj})%></td></tr></script>
<script class="fld_txt" type="text/html"><span id="id-<%=obj.fld%>"></span></script>
<script class="fld_edit" type="text/html"><input class="edit" type="text" id="id-<%=obj.fld%>" value="<%=obj.v%>" <%=(obj.w?'style="width:'+obj.w+';min-width:'+obj.w+'"':'')%>/><%=(obj.suf?'&nbsp;'+obj.suf:'')%></script>
<script class="fld_pwd" type="text/html"><nobr><input class="pwd" type="password" id="id-<%=obj.fld%>" value="<%=obj.v%>" <%=(obj.w?'style="width:'+obj.w+';min-width:'+obj.w+'"':'')%>/>&nbsp;<img src="/eye.m.svg" class="ico" onclick="peep(this)" style="vertical-align:middle;"/></nobr></script>
<script class="fld_chk" type="text/html"><input type="checkbox" id="id-<%=obj.fld%>" class="chk" <%=(obj.v>0?"checked":"")%> style="transform:scale(1.5);"/></script>
<script class="fld_cb" type="text/html"><select id="id-<%=obj.fld%>"><% for(var i=0,_a=obj.v.split('|');i<_a.length;i++) { %><option value="<%=i%>"><%=_a[i]%></option>;<% } %></select></script>
<script class="fld_btn" type="text/html"><% for(var i=0,_a=obj.b.split('|');i<_a.length;i++) { %><input type="button" class="btn" value="<%=_a[i]%>" onclick="<%=obj.click.replace('!',i)%>"/>&nbsp;<% } %></script>
<script class="fld_list" type="text/html"><table class="tbl" id="id-<%=obj.fld%>"></table></script>
<script class="apitem" type="text/html"><tr><td><b><%=ssid%></b></td><td><%=ch%></td><td><%=rssi%></td><td><%=sec%></td></tr></script>
<script class="pinitem" type="text/html"><td><select class="pinnum"><%=nsTmpl.tmplr('selopt',cEnv.gpio)%></select></td><td width="90%"><select class="pintype"><%=nsTmpl.tmplr('selopt',cEnv.hwtype)%></select></td><td><img src="/config.m.svg" class="ico" onclick="pin_cfg(this)" title="Configure logic"></td><td><img src="/remove.m.svg" class="ico" onclick="pin_del(this)" title="Do not use this pin"/></td></script>
<script class="selopt" type="text/html"><option value="<%=id%>"><%=name%></option></script>
</html>