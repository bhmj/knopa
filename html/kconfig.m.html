<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name=viewport content="width=device-width, initial-scale=1">
<title>Pin Config</title>
<link rel="stylesheet" type="text/css" href="/knopa.m.css"/>
<script type="text/javascript" src="/knopa.m.js"></script>
<script type="text/javascript">/*<![CDATA[*/function init(){var d=[{n:"Rules"},{n:"Info"},{n:"Control"}];var a=[[{n:"&nbsp;",t:"2btn",b:"Add...",click:"rule_add()"},{t:"2list",fld:"rule"},{n:"&nbsp;",t:"2btn",b:"Save",click:"rule_save()"},],[{n:"Type",t:"txt",fld:"name"},{n:"Description",t:"txt",fld:"descr"},],[{n:"&nbsp;",t:"2btn",b:"Apply",click:"apply()"},{t:"2list",fld:"data"},]];$("tabs").innerHTML=nsTmpl.tmplr("tab",d);d=$$(".tab");for(var c=0;c<d.length;c++){var f=document.createElement("div");f.className="sheet "+(c?"":"sel");var b='<table class="tbl">'+nsTmpl.tmplr("tblrow",a[c])+"</table>";f.innerHTML=b;$("space").appendChild(f)}tab_switch(d[0]);cEnv.pin=window.location.href.replace(/.*\?(.*)/g,"$1").match(/pin=(\d+)/)[1];cEnv.rtype=[{txt:"Immediate"},{txt:"Callable"}];cEnv.binopts=[{txt:"Low"},{txt:"High"}];ajaxGet("config","read="+cEnv.pin,data_ready)}function status(){ajaxGetq("/config","status=1",data_ready,1)}function data_ready(g,d){var e,b,f,h=pjson(g);if(!h){return}for(var c in h){if(h.hasOwnProperty(c)){var a=h[c];cEnv[c]=a;if(c=="rules"){for(e=0;e<a.length;e++){rule_add(a[e])}}}}for(e=0;e<cEnv.hwpins.length;e++){if(cEnv.hwpins[e].pin==cEnv.pin){f=cEnv.hwpins[e].type}}for(var e=0,b=cEnv.hwtypes;e<b.length;e++){if(b[e].id==f){$("id-name").innerHTML=b[e].name;$("id-descr").innerHTML=b[e].descr}}act_sel($$('input[value="Apply"]')[0]);if(!d){msg("",1)}}function tab_switch(d){var c=$$(".tab");var b=$$(".sheet");for(var a=0;a<c.length;a++){c[a].className=c[a]==d?"tab sel":"tab";b[a].className=c[a]==d?"sheet sel":"sheet"}}function set_rule(b){cEnv.rule=extend(b,{code:"",name:"",type:0,conditions:[],actions:[]});for(var a=0;a<cEnv.rtype.length;a++){cEnv.rtype[a].selected=a==cEnv.rule.type}}function rule_add(d){var b;set_rule(d);var c=document.createElement("tr");var a=nsTmpl.tmpl("rule_item",cEnv);c.innerHTML=nsTmpl.tmpl("rule_item",cEnv);$("id-rule").appendChild(c);for(b=0;b<cEnv.rule.conditions.length;b++){cond_add($$("tbody.cond",c)[0],cEnv.rule.conditions[b])}for(b=0;b<cEnv.rule.actions.length;b++){act_add($$("tbody.act",c)[0],cEnv.rule.actions[b])}}function rule_del(a){var b=$top($top(a,"table"),"tr");b.parentElement.removeChild(b)}function rule_save(){function d(h,m){var i,l,j=$$(h,this),g=j.length;if(!g){return m>0?new Array(m):""}l=j[0].className;if(l.match("time")){i=$PP;m=2}if(l.match("ival")){m=2}if(m>1){return[i?i(j[0].value):j[0].value,g>1?(i?i(j[1].value):j[1].value):""]}else{return j[0].value}}var e=$$("table.rule");var f=[];for(var c=0;c<e.length;c++){var a={};var b=e[c];b.vv=d;a.code=b.vv(".r_code");a.name=b.vv(".r_name");a.type=b.vv(".r_type");a.conditions=c_get(b);a.actions=a_get(b);f.push(a)}ajaxPostq("config","rules="+encodeURIComponent(JSON.stringify(f)),rule_saved);console.log(JSON.stringify(f))}function c_get(d){var b=[];var h=$$("tbody.cond",d)[0];while(1){h=h.nextSibling;if(h.className=="act"){break}h.vv=d.vv;var f={};f.id=h.vv(".cond_sel");f.ival=[];var c=$$(".c_par",h);for(var e=0;e<c.length;e++){var a=c[e];a.vv=d.vv;var g=a.vv(".cond",2);f.ival.push(g)}b.push(f)}return b}function a_get(b){var a=[];var e=$$("tbody.act",b)[0];while(1){e=e.nextSibling;if(!e){break}var d={};d.id=b.vv.call(e,".act_sel");d.parm=[];var f=$$(".a_par",e);for(var c=0;c<f.length;c++){d.parm.push(b.vv.call(f[c],".act"))}a.push(d)}return a}function rule_saved(){msg("Saved OK")}function hwpin(c){var b=cEnv.hwpins;for(var a=0;a<b.length;a++){if(b[a].pin==c){return b[a]}}}function pintype(d,c){var b=cEnv.hwtypes;for(var a=0;a<b.length;a++){if(b[a].id==d&&((c&&b[a].io)||(!c&&!b[a].io))){return b[a]}}}function rule_sz(b){var a,c=$top(b,"tbody");a=b.innerHTML;while(c.nextSibling){c=c.nextSibling;c.style.display=a=="-"?"none":"table-row-group"}b.innerHTML=a=="-"?"+":"-"}function cond_add(f,g){var d,k=$top(f,"tbody");while(k.className!="act"){k=k.nextSibling}var j=document.createElement("tbody");var b=[{id:0,txt:"Period"},{id:1,txt:"Cron"}];var c=cEnv.hwpins;for(d=0;d<c.length;d++){var h=pintype(c[d].type,1);if(h){b.push({id:c[d].pin+10,txt:"PIN "+c[d].pin+": "+h.name,io:h.io})}}if(g){for(d=0;d<b.length;d++){if(b[d].id==g.id){b[d].selected=1}}}j.innerHTML=nsTmpl.tmpl("cond_group",{a:b});k.parentNode.insertBefore(j,k);cond_sel($$(".cond_sel",j)[0],g)}function cond_del(a){$X($top(a,"tbody"))}function cond_sel(d,k){var a=$top(d,"tr");while(a.nextSibling){$X(a.nextSibling)}var j,h,m=d.value|0;var n=m>10?pintype(hwpin(m-10).type,1):{};var g=m<10?[0]:n.units;for(var c=0;c<g.length;c++){var f=document.createElement("tr");f.className="c_par";j=k?k.ival[c][0]:"";h=k?k.ival[c][1]:"";if(n.io==1){for(var l=0;l<cEnv.binopts.length;l++){cEnv.binopts[l].selected=j==l?1:0}}if(m==0){f.innerHTML=nsTmpl.tmpl("cond_period",{phold0:"mon 00:00:00",phold1:"sun 23:59:59",val0:$PR(j),val1:$PR(h)})}else{if(m==1){f.innerHTML=nsTmpl.tmpl("cond_cron",{phold:"nn hh dd mm dw yyyy",val:j})}else{f.innerHTML=nsTmpl.tmpl("cond_pin",{txt:g[c].txt,io:n.io,val0:j,val1:h})}}a.parentNode.insertBefore(f,a.nextSibling);a=f}}function act_add(g,c){var k,b,f,j=$top(g,"tbody");k=document.createElement("tbody");b=[];f=cEnv.sysacts;for(var d=0;d<f.length;d++){b.push({id:f[d].id,txt:f[d].action})}f=cEnv.hwpins;for(var d=0;d<f.length;d++){var h=pintype(f[d].type,0);if(h){b.push({id:f[d].pin+10,txt:"PIN "+f[d].pin+": "+h.name})}}if(c){for(d=0;d<b.length;d++){if(b[d].id==c.id){b[d].selected=1}}}k.innerHTML=nsTmpl.tmpl("act_group",{a:b});j.parentNode.insertBefore(k,null);act_sel($$(".act_sel",k)[0],c.parm)}function cond_del(a){$X($top(a,"tbody"))}function act_sel(h,o){var b=$top(h,"tr");while(b.nextSibling){$X(b.nextSibling)}var l=$top(h,"tbody");var r=h.value|0;var q=r<10?cEnv.sysacts[r]:pintype(hwpin(r-10).type,0);q=q.params;for(var k=0;k<q.length;k++){var g,d;if(o){d=o[k]}var b=q[k].split(":");var n=document.createElement("tr");n.className="a_par";if(b[0]=="i"){g={phold:b[1],txt:b[2],val:d}}if(b[0]=="t"){g={phold:b[1],val:d}}if(b[0]=="s"){var c=b[1].split("|"),m=[];for(var f=0;f<c.length;f++){m.push({txt:c[f],selected:d==f})}g={opts:m}}n.innerHTML=nsTmpl.tmpl("act_parm_"+b[0],g);l.appendChild(n)}}function apply(){ajaxGetq("config","apply=1",data_ready)};/*]]>*/</script>
</head>
<body onload="init()"><div class="page"><h1>Pin Setup</h1><ul id="tabs"></ul><div id="space"></div><div id="footer"><div id="err"></div><div id="msg"></div></div></div></body>
<script class="tab" type="text/html"><li class="tab" onclick="tab_switch(this)"><%=n%></li></script>
<script class="tblrow" type="text/html"><tr class="row"><% if (t[0]!='2') { %><td class="cell"><%=n%></td><% } %><td class="cell" <%=(t[0]=='2'?'colspan=2':'')%>><%=nsTmpl.tmpl('fld_'+t.replace(/\d/,'' ),{obj:obj})%></td></tr></script>
<script class="fld_txt" type="text/html"><span id="id-<%=obj.fld%>"></span></script>
<script class="fld_edit" type="text/html"><input type="text" class="edit time" id="id-<%=obj.fld%>" value="<%=obj.v%>" <%=(obj.w?'style="width:'+obj.w+'"':'')%>/><%=(obj.suf?'&nbsp;'+obj.suf:'')%></script>
<script class="fld_chk" type="text/html"><input type="checkbox" id="id-<%=obj.fld%>" class="chk" <%=(obj.v>0?"checked":"")%> style="transform:scale(1.5);"/></script>
<script class="fld_btn" type="text/html"><% for(var i=0,_a=obj.b.split('|');i<_a.length;i++) { %><input type="button" class="btn" value="<%=_a[i]%>" onclick="<%=obj.click.replace('!',i)%>"/>&nbsp;<% } %></script>
<script class="fld_list" type="text/html"><table class="tbl" id="id-<%=obj.fld%>"></table></script>
<script class="rule_item" type="text/html"><tr><td><table class="rule"><tbody class="rhead"><tr><td><div class="minmax" onclick="rule_sz(this)">-</div>Code</td><td><input type="text" class="edit r_code" placeholder="4 chars" value="<%=rule.code%>">&nbsp;<img src="/remove.m.svg" class="ico ico-r" onclick="rule_del(this)" title="Delete rule"/></td></tr></tbody><tbody class="cond"><tr><td>Title</td><td><input type="text" class="edit r_name" placeholder="Rule title" value="<%=rule.name%>"></td></tr><tr><td>Type</td><td><select class="r_type"><%=nsTmpl.tmplr('sel_opt',cEnv.rtype)%></select></td></tr><tr class="gray"><td>CONDITIONS</td><td><img src="/item-add.svg" class="ico" onclick="cond_add(this)" title="Add condition"/></td></tr></tbody><tbody class="act"><tr class="gray"><td>ACTIONS</td><td><img src="/item-add.svg" class="ico" onclick="act_add(this)" title="Add action"/></td></tr></tbody></table></td></tr></script>
<script class="sel_opt" type="text/html"><option value="<%=(typeof(id)=='undefined'?_index:id)%>"<%=(obj.selected?' selected':'')%>><%=txt%></option></script>
<script class="cond_group" type="text/html"><tr><td>Case</td><td><select class="cond_sel" onclick="cond_sel(this)" onkeyup="cond_sel(this)" onchange="cond_sel(this)">'<%=nsTmpl.tmplr('sel_opt',a)%></select><img src="/item-del.svg" class="ico ico-r" onclick="cond_del(this)" title="Delete condition"/></td></tr></script>
<script class="cond_period" type="text/html"><td>&nbsp;</td><td><input type="text" class="edit cond time" placeholder="<%=phold0%>" value="<%=obj.val0%>">&nbsp;<input type="text" class="edit cond time" placeholder="<%=phold1%>" value="<%=obj.val1%>"></td></script>
<script class="cond_cron" type="text/html"><td>&nbsp;</td><td><input type="text" class="edit cond cron" placeholder="<%=phold%>" value="<%=obj.val%>"></td></script>
<script class="cond_pin" type="text/html"><td><%=txt%></td><td><% if (io==1) { %><select class="cond"><%=nsTmpl.tmplr('sel_opt',cEnv.binopts)%></select><% } else { %><input class="edit cond ival ival0" value="<%=obj.val0%>">&nbsp;...&nbsp;<input class="edit cond ival ival1" value="<%=obj.val1%>"><% } %></td></tr><tr></script>
<script class="act_group" type="text/html"><tr><td>&nbsp;</td><td><select class="act_sel" onclick="act_sel(this)" onkeyup="act_sel(this)" onchange="act_sel(this)">'<%=nsTmpl.tmplr('sel_opt',a)%></select><img src="/item-del.svg" class="ico ico-r" onclick="cond_del(this)" title="Delete action"/></td></tr></script>
<script class="act_parm_i" type="text/html"><td>&nbsp;</td><td><input type="text" class="edit iparm act" placeholder="<%=phold%>" value="<%=val%>">&nbsp;<span class="punit"><%=txt%></span></td></script>
<script class="act_parm_t" type="text/html"><td>&nbsp;</td><td><input type="text" class="edit act" placeholder="<%=phold%>" value="<%=val%>"></td></script>
<script class="act_parm_s" type="text/html"><td>&nbsp;</td><td><select class="act"><%=nsTmpl.tmplr('sel_opt',opts)%></select></td></script>
</html>